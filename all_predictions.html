<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo.png" type="image/png">
    <title>Centrosome Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/button.css">
    <link rel="stylesheet" href="css/collapsible-section.css">
    <link rel="stylesheet" href="css/header-footer.css">
    <link rel="stylesheet" href="css/filter.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/plots.css">
    <link rel="stylesheet" href="css/protein-search.css">
    <link rel="stylesheet" href="css/search.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/stat-cards.css">
    <link rel="stylesheet" href="css/structure-viewer.css">
    <link rel="stylesheet" href="css/table.css">
    <link rel="stylesheet" href="css/tooltip.css">
    </head>
<body class="index-page">
    <div id="header-placeholder"></div>

    <div class="container">
        <div class="main-content">
            <div class="grid">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-search"></i> Protein Search</h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" id="proteinSearch" placeholder="Search proteins...">
                                <ul id="proteinList" class="protein-dropdown"></ul>
                            </div>
                            
                            <div class="search-mode">
                                <div class="mode-option">
                                    <input type="radio" id="modeIncludes" name="searchMode" value="includes" checked>
                                    <label for="modeIncludes">Including
                                        <span class="info-btn" data-tooltip="Show all rows including any of the searched proteins.">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </label>
                                </div>
                                <div class="mode-option">
                                    <input type="radio" id="modeOnly" name="searchMode" value="only">
                                    <label for="modeOnly">Only
                                        <span class="info-btn" data-tooltip="Show only rows where both proteins involved are in your selected protein list.">
                                            <i class="fas fa-info-circle"></i>
                                        </span>
                                    </label>
                                </div>
                            </div>
                            <div id="selected-proteins" class="filter-tags"></div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-filter"></i> Numerical Filters</h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <div class="filter-group">
                                <label for="filterColumn">Filter by Column</label>
                                <select id="filterColumn" class="filter-control">
                                    <option value="">Select a column</option>
                                    <option value="min_pae">min_pae</option>
                                    <option value="avg_pae">avg_pae</option>
                                    <option value="iptm">ipTM</option>
                                    <option value="pdockq">pDockQ</option>
                                    <option value="rop">rop</option>
                                    <option value="max_promiscuity">max_promiscuity</option>
                                    <option value="size">size</option>
                                    <option value="evenness">evenness</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filterCondition">Condition</label>
                                <select id="filterCondition" class="filter-control">
                                    <option value="above">Above</option>
                                    <option value="below">Below</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filterValue">Value</label>
                                <input type="number" id="filterValue" class="filter-control" step="0.1" placeholder="Enter value">
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn btn-primary" id="applyFilter">
                                    <i class="fas fa-filter"></i> Apply Filter
                                </button>
                                <button class="btn btn-outline" id="resetFilters">
                                    <i class="fas fa-sync-alt"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-chart-line"></i> Stats Summary</h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" id="filteredCount"></div>
                                    <div class="stat-label">Interactions meeting filter criteria</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="proteinCount"></div>
                                    <div class="stat-label">Proteins</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="fragmentCount"></div>
                                    <div class="stat-label">Fragments</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
                
                <main class="content-area">
                    <h2 class="section-title"><i class="fas fa-table"></i>All Predictions</h2>
                    <div class="active-filters">
                        <h3>Active Filters:</h3>
                        <div class="filter-tags" id="active-filters"></div>
                    </div>
                    <div class="table-container">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th data-column="Proteins">
                                        Proteins 
                                    </th>
                                    <th data-column="min_pae">
                                        <span class="header-main-text">min_pae</span>
                                    </th>
                                    <th data-column="avg_pae">
                                        <span class="header-main-text">avg_pae</span>
                                    </th>
                                    <th data-column="iptm">
                                        <span class="header-main-text">ipTM</span>
                                    </th>
                                    <th data-column="pdockq">
                                        <span class="header-main-text">pDockQ</span>
                                    </th>
                                    <th data-column="rop">
                                        <span class="header-main-text">ROP</span>
                                    </th>
                                    <th data-column="max_promiscuity">
                                        <span class="header-main-text">Max Promiscuity</span>
                                    </th>
                                    <th data-column="size">
                                        <span class="header-main-text">Size</span>
                                    </th>
                                    <th data-column="evenness">
                                        <span class="header-main-text">Evenness</span>
                                    </th>
                                    <th data-column="location">
                                        Location 
                                    </th>
                                    <th data-column="relative_location">
                                        Relative Location 
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pagination"></div>

                    <h2 class="section-title" style="margin-top: 40px;"><i class="fas fa-project-diagram"></i> Chord Plot</h2>
                    <div class="chord-plot-container"></div>
                </main>
            </div>
        </div>
    </div>
    
    <div id="footer-placeholder"></div>

    <script type="module">
        import { loadHTMLIncludes } from './js/header-footer.js';
        import * as table from './js/table.js';
        import * as filter from './js/filter.js';
        import * as stats from './js/stats.js';
        import { initializeChordPlot } from './js/chord-plot.js';
        import { initCollapsibleSectionsSimple } from './js/collapsible-section.js';
        import { initTooltips } from './js/tooltip.js';

        function setupSidebarEventListeners() {
            document.querySelectorAll('input[name="searchMode"]').forEach(input => {
                input.addEventListener('change', function() {
                    table.setSearchMode(this.value);
                    table.renderTable();
                    initializeChordPlotWrapper();
                });
            });

            document.getElementById('applyFilter').addEventListener('click', () => {
                const column = document.getElementById('filterColumn').value;
                const condition = document.getElementById('filterCondition').value;
                const value = document.getElementById('filterValue').value;
                if (!column || value.trim() === '') {
                    alert('Please select a valid column and enter a numerical value');
                    return;
                }
                filter.refineNumericFilter(column, condition, value);
            });

            document.getElementById('resetFilters').addEventListener('click', () => {
                setColumnFilters({});
                setSelectedProteins([]);
                document.getElementById('proteinSearch').value = '';
                document.getElementById('filterColumn').value = '';
                document.getElementById('filterCondition').value = 'above';
                document.getElementById('filterValue').value = '';
            });
        }
    
        function updateStats(filteredData, allData) {
            const proteinCount = document.getElementById('proteinCount');
            const fragmentCount = document.getElementById('fragmentCount');
            const filteredCount = document.getElementById('filteredCount');
            if (!allData) allData = table.tableData;
            if (!filteredData) filteredData = allData;
            filteredCount.textContent = filteredData.length;
            const proteins = [...new Set([
                ...allData.map(row => row.Protein1),
                ...allData.map(row => row.Protein2)
            ])];
            proteinCount.textContent = proteins.length;
            const fragments = [...new Set([
                ...allData.map(row => row.Protein1_Domain),
                ...allData.map(row => row.Protein2_Domain)
            ])];
            fragmentCount.textContent = fragments.length;
        }

        async function initializeChordPlotWrapper() {
            const filteredData = filter.getFilteredData();

            await initializeChordPlot({
                queryProteins: [],
                data: filteredData,
                size: 600,
                coloringMode: 'gradient',
                showDomainsOnArcs: false,
                expandQuery: false
            });
        }

        function setupProteinSearch() {
            const proteinSearch = document.getElementById('proteinSearch');
            const proteinList = document.getElementById('proteinList');
            
            if (!proteinSearch || !proteinList) return;

            proteinSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();

                const uniqueProteins = Array.from(table.state.uniqueProteins);
                
                const filteredProteins = uniqueProteins
                    .filter(protein => protein.toLowerCase().includes(searchTerm))
                    .sort();

                proteinList.innerHTML = '';
                filteredProteins.forEach(protein => {
                    const li = document.createElement('li');
                    li.textContent = protein;
                    li.addEventListener('click', () => {
                        const currentSelected = filter.getSelectedProteins();
                        const updatedProteins = [...currentSelected];
                        if (!updatedProteins.includes(protein)) {
                            updatedProteins.push(protein);
                            filter.setSelectedProteins(updatedProteins);
                            filter.updateActiveFilterDisplay();
                            table.renderTable();
                        }
                        proteinSearch.value = '';
                        proteinList.innerHTML = '';
                    });
                    proteinList.appendChild(li);
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!proteinSearch.contains(e.target) && !proteinList.contains(e.target)) {
                    proteinList.innerHTML = '';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadHTMLIncludes('navAllPredictions');
            initCollapsibleSectionsSimple();
            
            // Set UI update hooks and filter change callback first
            stats.setUpdateStatsUI(updateStats);
            filter.setOnFiltersChanged(() => {
                filter.updateActiveFilterDisplay();
                initializeChordPlotWrapper();
            });

            setupProteinSearch();
            initTooltips('.sidebar');
            
            await table.initializeTable({});
            setupSidebarEventListeners();
        });
    </script>
</body>
</html>