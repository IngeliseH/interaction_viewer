<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo.png" type="image/png">
    <title>Centrosome Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/button.css">
    <link rel="stylesheet" href="css/collapsible-section.css">
    <link rel="stylesheet" href="css/header-footer.css">
    <link rel="stylesheet" href="css/filter.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/plots.css">
    <link rel="stylesheet" href="css/protein-search.css">
    <link rel="stylesheet" href="css/search.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/stat-cards.css">
    <link rel="stylesheet" href="css/structure-viewer.css">
    <link rel="stylesheet" href="css/table.css">
    <link rel="stylesheet" href="css/tooltip.css">
    </head>
<body class="index-page">
    <div id="header-placeholder"></div>

    <div class="container">
        <div class="main-content">
            <div class="grid">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-search"></i> Protein Search</h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" id="proteinSearch" placeholder="Search proteins...">
                                <ul id="proteinList" class="protein-dropdown"></ul>
                            </div>
                            
                            <div class="search-mode">
                                <div class="mode-option">
                                    <input type="radio" id="modeIncludes" name="searchMode" value="includes" checked>
                                    <label for="modeIncludes">Including
                                        <span class="info-btn">
                                            <i class="fas fa-info-circle"></i>
                                        <div class="info-tooltip">Show all rows including any of the searched proteins.</div>
                                        </span>
                                    </label>
                                </div>
                                <div class="mode-option">
                                    <input type="radio" id="modeOnly" name="searchMode" value="only">
                                    <label for="modeOnly">Only
                                        <span class="info-btn">
                                            <i class="fas fa-info-circle"></i>
                                        <div class="info-tooltip">Show only rows where both proteins involved are in your selected protein list.</div>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-filter"></i> Numerical Filters</h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <div class="filter-group">
                                <label for="filterColumn">Filter by Column</label>
                                <select id="filterColumn" class="filter-control">
                                    <option value="">Select a column</option>
                                    <option value="min_pae">min_pae</option>
                                    <option value="avg_pae">avg_pae</option>
                                    <option value="iptm">ipTM</option>
                                    <option value="pdockq">pDockQ</option>
                                    <option value="rop">rop</option>
                                    <option value="max_promiscuity">max_promiscuity</option>
                                    <option value="size">size</option>
                                    <option value="evenness">evenness</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filterCondition">Condition</label>
                                <select id="filterCondition" class="filter-control">
                                    <option value="above">Above</option>
                                    <option value="below">Below</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="filterValue">Value</label>
                                <input type="number" id="filterValue" class="filter-control" step="0.1" placeholder="Enter value">
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn btn-primary" id="applyFilter">
                                    <i class="fas fa-filter"></i> Apply Filter
                                </button>
                                <button class="btn btn-outline" id="resetFilters">
                                    <i class="fas fa-sync-alt"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-chart-line"></i> Stats Summary</h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" id="filteredCount"></div>
                                    <div class="stat-label">Interactions meeting filter criteria</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="proteinCount"></div>
                                    <div class="stat-label">Proteins</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="fragmentCount"></div>
                                    <div class="stat-label">Fragments</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
                
                <main class="content-area">
                    <h2 class="section-title"><i class="fas fa-table"></i>All Predictions</h2>
                    <div class="active-filters">
                        <h3>Active Filters:</h3>
                        <div class="filter-tags" id="active-filters"></div>
                    </div>
                    <div class="table-container">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th data-column="Proteins">
                                        Proteins 
                                    </th>
                                    <th data-column="min_pae">
                                        <span class="header-main-text">min_pae</span> 
                                        <span class="filter-icon">
                                            <i class="fas fa-filter"></i>
                                        </span>
                                    </th>
                                    <th data-column="avg_pae">
                                        <span class="header-main-text">avg_pae</span> 
                                        <span class="filter-icon">
                                            <i class="fas fa-filter"></i>
                                        </span>
                                    </th>
                                    <th data-column="iptm">
                                        <span class="header-main-text">ipTM</span> 
                                        <span class="filter-icon">
                                            <i class="fas fa-filter"></i>
                                        </span>
                                    </th>
                                    <th data-column="pdockq">
                                        <span class="header-main-text">pDockQ</span> 
                                        <span class="filter-icon">
                                            <i class="fas fa-filter"></i>
                                        </span>
                                    </th>
                                    <th data-column="rop">
                                        <span class="header-main-text">ROP</span> 
                                        <span class="filter-icon">
                                            <i class="fas fa-filter"></i>
                                        </span>
                                    </th>
                                    <th data-column="max_promiscuity">
                                        <span class="header-main-text">Max Promiscuity</span> 
                                        <span class="filter-icon">
                                            <i class="fas fa-filter"></i>
                                        </span>
                                    </th>
                                    <th data-column="size">
                                        <span class="header-main-text">Size</span> 
                                        <span class="filter-icon">
                                            <i class="fas fa-filter"></i>
                                        </span>
                                    </th>
                                    <th data-column="evenness">
                                        <span class="header-main-text">Evenness</span> 
                                        <span class="filter-icon">
                                            <i class="fas fa-filter"></i>
                                        </span>
                                    </th>
                                    <th data-column="location">
                                        Location 
                                    </th>
                                    <th data-column="relative_location">
                                        Relative Location 
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pagination"></div>

                    <h2 class="section-title" style="margin-top: 40px;"><i class="fas fa-project-diagram"></i> Chord Plot</h2>
                    <div class="chord-plot-container"></div>
                </main>
            </div>
        </div>
    </div>
    
    <div id="footer-placeholder"></div>

    <script type="module">
        import { loadHTMLIncludes } from './js/header-footer.js';
        import * as table from './js/table.js';
        import * as filter from './js/filter.js';
        import * as pagination from './js/pagination.js';
        import * as stats from './js/stats.js';
        import { initializeChordPlot } from './js/chord-plot.js';
        import { initCollapsibleSectionsSimple } from './js/collapsible-section.js';

        // Set up column descriptions for info tooltips
        table.setColumnDescriptions({
            "Proteins": "Proteins involved in the interaction, and the fragments used in the prediction in which this interaction is seen. Multiple interactions may be seen between the same proteins and the same fragments.",
            "min_pae": "Minimum PAE value for the interface. PAE gives the predicted error in the relative positioning of 2 residues, with lower values indicating more confident relative positioning. This is the best (lowest) PAE for any pair of residues from different proteins in this interface.",
            "avg_pae": "Average PAE across the interface. PAE gives the predicted error in the relative positioning of 2 residues, with lower values indicating more confident relative positioning. This is the average PAE for all pairs of residues from different proteins in this interface.",
            "iptm": "Interface predicted TM-score (ipTM). Higher values indicate higher model quality (0-1). Values above 0.55 indicate an interaction. Scores are typically lower on coiled coil predictions and predictions with larger input, especially when multiple regions of the predicted structure are within interaction distance with varying confidences. ",
            "pdockq": "pDockQ score estimates the goodness of fit of the modeled interaction interface (0-1). It is based on the actual structure rather than prediction confidence. Scores above 0.23 indicate a plausible interaction. Can be biased towards coiled-coil structures.",
            "rop": "Repeatability of Prediction. How many times (out of 4) the same interface was predicted in repeat runs. A score of 4 indicates high consistency.",
            "max_promiscuity": "The higher of the two partners' promiscuity scores. Represents the number of other interactions predicted for the same interface region. A high score may indicate a non-specific binding site, or completion bias.",
            "size": "The number of residue pairs within interaction distance at the interface.",
            "evenness": "How evenly balanced the interaction confidence is in each direction (Protein 1 -> Protein 2 vs. Protein 2 -> Protein 1).",
            "location": "Location of the regions involved in this predicted interaction in each full length protein. This is not necessarily every interacting region between these proteins or these fragments.",
            "relative_location": "The interacting residue ranges within the protein fragments used for prediction. Useful for mapping to the predicted structure."
        });

        // --- Sidebar Event Listeners ---
        function setupSidebarEventListeners() {
            // Search mode
            document.querySelectorAll('input[name="searchMode"]').forEach(input => {
                input.addEventListener('change', function() {
                    table.setSearchMode(this.value);
                    table.renderTable();
                    initializeChordPlotWrapper();
                });
            });

            // Sidebar filter apply
            document.getElementById('applyFilter').addEventListener('click', () => {
                const column = document.getElementById('filterColumn').value;
                const condition = document.getElementById('filterCondition').value;
                const value = document.getElementById('filterValue').value;
                if (!column || value.trim() === '') {
                    alert('Please select a valid column and enter a numerical value');
                    return;
                }
                filter.refineNumericFilter(column, condition, value);
            });

            document.getElementById('resetFilters').addEventListener('click', () => {
                setColumnFilters({});
                setSelectedProteins([]);
                document.getElementById('proteinSearch').value = '';
                document.getElementById('filterColumn').value = '';
                document.getElementById('filterCondition').value = 'above';
                document.getElementById('filterValue').value = '';
            });
        }

    
        function updateStats(filteredData, allData) {
            const proteinCount = document.getElementById('proteinCount');
            const fragmentCount = document.getElementById('fragmentCount');
            const filteredCount = document.getElementById('filteredCount');
            if (!allData) allData = table.tableData;
            if (!filteredData) filteredData = allData;
            filteredCount.textContent = filteredData.length;
            const proteins = [...new Set([
                ...allData.map(row => row.Protein1),
                ...allData.map(row => row.Protein2)
            ])];
            proteinCount.textContent = proteins.length;
            const fragments = [...new Set([
                ...allData.map(row => row.Protein1_Domain),
                ...allData.map(row => row.Protein2_Domain)
            ])];
            fragmentCount.textContent = fragments.length;
        }

        async function initializeChordPlotWrapper() {
            const filteredData = filter.getFilteredData();

            await initializeChordPlot({
                queryProteins: [],
                data: filteredData,
                size: 600,
                coloringMode: 'gradient',
                showDomainsOnArcs: false,
                expandQuery: false
            });
        }

        function setupProteinSearch() {
            const proteinSearch = document.getElementById('proteinSearch');
            const proteinList = document.getElementById('proteinList');
            
            if (!proteinSearch || !proteinList) return;

            proteinSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();

                const uniqueProteins = Array.from(table.state.uniqueProteins);
                
                const filteredProteins = uniqueProteins
                    .filter(protein => protein.toLowerCase().includes(searchTerm))
                    .sort();

                proteinList.innerHTML = '';
                filteredProteins.forEach(protein => {
                    const li = document.createElement('li');
                    li.textContent = protein;
                    li.addEventListener('click', () => {
                        const currentSelected = filter.getSelectedProteins();
                        const updatedProteins = [...currentSelected];
                        if (!updatedProteins.includes(protein)) {
                            updatedProteins.push(protein);
                            filter.setSelectedProteins(updatedProteins);
                            filter.updateActiveFilterDisplay();
                            table.renderTable();
                        }
                        proteinSearch.value = '';
                        proteinList.innerHTML = '';
                    });
                    proteinList.appendChild(li);
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!proteinSearch.contains(e.target) && !proteinList.contains(e.target)) {
                    proteinList.innerHTML = '';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadHTMLIncludes('navAllPredictions');
            initCollapsibleSectionsSimple();
            await table.loadTableData();
            pagination.initPagination();
            
            // Set UI update hooks and filter change callback first
            stats.setUpdateStatsUI(updateStats);
            filter.setOnFiltersChanged(() => {
                filter.updateActiveFilterDisplay();
                initializeChordPlotWrapper();
            });

            setupProteinSearch();

            const initialNumericFilters = {
                min_pae: { max: 5 },
                avg_pae: { max: 15 },
                rop: { min: 2 }
            };
            filter.setColumnFilters(initialNumericFilters);
            pagination.setUpdatePaginationUI(table.updatePaginationControls);
            
            table.initTable();
            setupSidebarEventListeners();
        });
    </script>
</body>
</html>