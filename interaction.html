<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo.png" type="image/png">
    <title>Centrosome Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
    <script type="module" src="js/promiscuity-plot.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/button.css">
    <link rel="stylesheet" href="css/collapsible-section.css">
    <link rel="stylesheet" href="css/header-footer.css">
    <link rel="stylesheet" href="css/filter.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/plots.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/stat-cards.css">
    <link rel="stylesheet" href="css/structure-viewer.css">
    <link rel="stylesheet" href="css/table.css">
    <link rel="stylesheet" href="css/tooltip.css">
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="container">
        <div class="main-content">
            <h1 class="page-main-heading">Centrosome Predicted Interaction Data Explorer</h1>
            <div class="grid">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-list-ul"></i> <span>Page Sections</span></h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <ul>
                                <li><a href="#interaction-details">Interaction Details</a></li>
                                <li><a href="#structure-viewer">Structure</a></li>
                                <li><a href="#domains-fragments">Domains and Fragments</a></li>
                                <li><a href="#promiscuity-plots">Promiscuity Plots</a></li>
                                <li><a href="#other-interactions">Other Interactions</a></li>
                            </ul>
                        </div>
                    </div>
                </aside>
                    
                <div class="content-column">
                    <main class="content-area">
                        <div class="content-section" id="interaction-details">
                            <div class="content-section-title">
                                <h2>Interaction Details</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div class="stats-card-row">
                                    <div class="stat-card" id="stat-card-iptm">
                                        <div class="stat-label">ipTM</div>
                                        <div class="stat-value" id="stat-iptm">-</div>
                                    </div>
                                    <div class="stat-card" id="stat-card-minpae">
                                        <div class="stat-label">min_pae</div>
                                        <div class="stat-value" id="stat-minpae">-</div>
                                    </div>
                                    <div class="stat-card" id="stat-card-avgpae">
                                        <div class="stat-label">avg_pae</div>
                                        <div class="stat-value" id="stat-avgpae">-</div>
                                    </div>
                                    <div class="stat-card" id="stat-card-rop">
                                        <div class="stat-label">ROP</div>
                                        <div class="stat-value" id="stat-rop">-</div>
                                    </div>
                                    <div class="stat-card" id="stat-card-pdockq">
                                        <div class="stat-label">pDockQ</div>
                                        <div class="stat-value" id="stat-pdockq">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="structure-viewer-section">
                            <div class="content-section-title">
                                <h2>Structure</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content" style="position: relative;">
                                <div id="structure-controls-placeholder"></div>
                                <div id="structure-viewer" class="structure-viewer"></div>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="domains-fragments">
                            <div class="content-section-title">
                                <h2>Domains and Fragments</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div id="domain-fragment-controls-placeholder"></div>
                                <div id="domain-fragment-plots-container"></div>
                                <p id="domain-fragments-fallback-message" style="text-align:center; display:block; margin-top: 15px;">
                                    Loading domain and fragment plots...
                                </p>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="promiscuity-plots">
                            <div class="content-section-title">
                                <h2>Promiscuity Plots</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <!-- Placeholder for global controls -->
                                <div id="promiscuity-controls-placeholder"></div>
                                <!-- Container for promiscuity plots -->
                                <div id="promiscuity-plots-container"></div>
                                <p id="promiscuity-fallback-message" style="text-align:center; display:block; margin-top: 15px;">
                                    Loading promiscuity plots...
                                </p>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="other-interactions">
                            <div class="content-section-title">
                                <h2>Other Interactions</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div id="other-interactions-list">
                                    <div class="active-filters">
                                        <h3>Active Filters:</h3>
                                        <div class="filter-tags" id="active-filters"></div>
                                    </div>
                                    <div class="table-container">
                                        <table id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th data-column="location">Location</th>
                                                    <th data-column="min_pae">
                                                        <span class="header-main-text">min_pae</span> 
                                                        <span class="filter-icon">
                                                            <i class="fas fa-filter"></i>
                                                        </span>
                                                    </th>
                                                    <th data-column="avg_pae">
                                                        <span class="header-main-text">avg_pae</span> 
                                                        <span class="filter-icon">
                                                            <i class="fas fa-filter"></i>
                                                        </span>
                                                    </th>
                                                    <th data-column="iptm">
                                                        <span class="header-main-text">ipTM</span> 
                                                        <span class="filter-icon">
                                                            <i class="fas fa-filter"></i>
                                                        </span>
                                                    </th>
                                                    <th data-column="pdockq">
                                                        <span class="header-main-text">pDockQ</span> 
                                                        <span class="filter-icon">
                                                            <i class="fas fa-filter"></i>
                                                        </span>
                                                    </th>
                                                    <th data-column="max_promiscuity">
                                                        <span class="header-main-text">Max Promiscuity</span> 
                                                        <span class="filter-icon">
                                                            <i class="fas fa-filter"></i>
                                                        </span>
                                                    </th>
                                                    <th data-column="rop">
                                                        <span class="header-main-text">ROP</span> 
                                                        <span class="filter-icon">
                                                            <i class="fas fa-filter"></i>
                                                        </span>
                                                    </th>
                                                    <th data-column="size">
                                                        <span class="header-main-text">Size</span> 
                                                        <span class="filter-icon">
                                                            <i class="fas fa-filter"></i>
                                                        </span>
                                                    </th>
                                                    <th data-column="evenness">
                                                        <span class="header-main-text">Evenness</span> 
                                                        <span class="filter-icon">
                                                            <i class="fas fa-filter"></i>
                                                        </span>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="tableBody">
                                                <!-- Data will be populated by JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="pagination" id="pagination">
                                        <!-- Pagination will be generated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>
    <div id="footer-placeholder"></div>
    <script type="module" src="js/promiscuity-plot.js"></script>
    <script type="module">
        import * as table from './js/table.js';
        import * as filter from './js/filter.js';
        import * as pagination from './js/pagination.js';
        import * as stats from './js/stats.js';
        import { updatePageTitle } from './js/page-title.js';
        import { fetchAndParseCSV, parseLocation2 } from './js/data.js';
        import { initializePromiscuityPlots, updateAllPromiscuityPlots, getPromiscuityFilterState } from './js/promiscuity-plot.js';
        import { loadHTMLIncludes } from './js/header-footer.js';
        import { initCollapsibleSectionsComplex } from './js/collapsible-section.js';
        import { initializeDomainFragmentPlots } from './js/domain-fragment-plot.js';
        import { updateInteractionStatsFromURL } from './js/stats.js';
        import { setUpStructureViewer } from './js/structure-viewer.js';

        const urlParams = new URLSearchParams(window.location.search);
        const p1 = decodeURIComponent(urlParams.get('p1') || ''); 
        const p2 = decodeURIComponent(urlParams.get('p2') || '');
        const f1_id = decodeURIComponent(urlParams.get('f1_id') || '');
        const f2_id = decodeURIComponent(urlParams.get('f2_id') || '');

        document.addEventListener('DOMContentLoaded', async () => {
            await loadHTMLIncludes('navProteinPairs');
            updatePageTitle([p1, p2], [f1_id, f2_id]);
            initCollapsibleSectionsComplex();

            const proteinLengthData = await fetchAndParseCSV('all_fragments_2025.06.04.csv');
            const interfaceData = await fetchAndParseCSV('all_interface_analysis_2025.06.05_shifted.csv');

            pagination.initPagination();
            pagination.setUpdatePaginationUI(pagination.updatePaginationControls);

            updateInteractionStatsFromURL(urlParams);

            async function loadOtherInteractions() {
                const container = document.getElementById('other-interactions-list');

                if (!p1 || !p2 || !container) {
                    const tableBody = document.querySelector('#other-interactions-list #tableBody');
                    if (tableBody) tableBody.innerHTML = '<tr><td colspan="9"><p>Protein pair not specified.</p></td></tr>';
                    return;
                }

                // Define initial filters, same as protein_pair.html
                const initialNumericFilters = {
                    min_pae: { max: 5 },
                    avg_pae: { max: 15 },
                    rop: { min: 2 }
                };

                const columnDescriptions = {
                    "query_fragment": "Query protein fragment (domain or fragment name).",
                    "partner": "Partner protein name.",
                    "partner_id": "UniProt accession ID of the partner protein.",
                    "Category": "Functional category of the partner protein.",
                    "min_pae": "Minimum Predicted Aligned Error (PAE) value. Lower values indicate higher confidence.",
                    "avg_pae": "Average Predicted Aligned Error (PAE) across the interface.",
                    "iptm": "Interface predicted TM-score (ipTM). Higher values indicate higher model quality (0-1).",
                    "pdockq": "pDockQ score estimates the confidence in the modeled interaction.",
                    "max_promiscuity": "Maximum promiscuity score of the two domains.",
                    "rop": "Residue Overlap Score (ROP) measures the proportion of residues in the domain that are involved in the interface.",
                    "size": "Size of the interaction interface in square Angstroms (Å²).",
                    "evenness": "How evenly distributed the interface residues are between the two proteins.",
                    "location": "Location of the interaction on each protein chain."
                };

                await table.loadTableData();
                table.setColumnDescriptions(columnDescriptions);
                filter.setColumnFilters(initialNumericFilters);

                filter.setOnFiltersChanged(() => {
                    filter.updateActiveFilterDisplay();
                    if (getPromiscuityFilterState()) {
                        updateAllPromiscuityPlots();
                    }
                });

                await table.loadTableData();
                filter.setColumnFilters(initialNumericFilters);
                filter.setSelectedProteins([p1, p2]);
                table.setSearchMode("pair-exact");
                pagination.setCurrentPage(1);
                pagination.setUpdatePaginationUI(table.updatePaginationControls);
                stats.setUpdateStatsUI(null);
                table.initTable();
                filter.updateActiveFilterDisplay();
                table.renderTable();
            }

            const interactionRegions = [
                parseLocation2(urlParams.get('f1_loc')),
                parseLocation2(urlParams.get('f2_loc'))
            ];

            await initializeDomainFragmentPlots({
                proteins: [p1, p2],
                interactionRegions
            });

            await initializePromiscuityPlots({
                proteins: [p1, p2],
                interactionRegions,
                proteinLengthData,
                interfaceData,
                filter,
                applyFilters: false
            });

            loadOtherInteractions();
            setUpStructureViewer(urlParams, [p1, p2], null);
        });
    </script>
</body>
</html>