<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo.png" type="image/png">
    <title>Centrosome Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/button.css">
    <link rel="stylesheet" href="css/collapsible-section.css">
    <link rel="stylesheet" href="css/header-footer.css">
    <link rel="stylesheet" href="css/filter.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/plots.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/stat-cards.css">
    <link rel="stylesheet" href="css/structure-viewer.css">
    <link rel="stylesheet" href="css/table.css">
    <link rel="stylesheet" href="css/tooltip.css">
</head>

<body>
    <div id="header-placeholder"></div>
    <div class="container">
        <div class="main-content">
            <h1 class="page-main-heading">Centrosome Predicted Interaction Data Explorer</h1>
            <h3 id="uniprot-accession-subheading" class="page-subtitle">Loading...</h3>
            <div class="grid">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-list-ul"></i> <span>Page Sections</span></h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <ul>
                                <li><a href="#protein-info">Protein Information</a></li>
                                <li><a href="#domains-fragments">Domains and Fragments</a></li>
                                <li><a href="#promiscuity-plot">Promiscuity Plot</a></li>
                                <li><a href="#ppi-table">PPI table</a></li>
                                <li><a href="#chord-plot">Chord Plot</a></li>
                                <li><a href="#structure-viewer-section">Structure</a></li>
                            </ul>
                        </div>
                    </div>
                </aside>

                <div class="content-column">
                    <main class="content-area">
                        <div class="content-section" id="protein-info">
                            <div class="content-section-title">
                                <h2>Protein Information</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">

                                <p><strong>UniProt Accession ID:</strong> <span id="uniprot-accession">Loading...</span>
                                </p>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="domains-fragments">
                            <div class="content-section-title">
                                <h2>Domains and Fragments</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div id="domain-fragment-controls-placeholder"></div>
                                <div id="domain-fragment-plots-container"></div>
                                <p id="domain-fragments-fallback-message" style="text-align:center; display:none; margin-top: 15px;">
                                    Loading domain and fragment plot...
                                </p>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="promiscuity-plot">
                            <div class="content-section-title">
                                <h2>Promiscuity Plot</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div id="promiscuity-controls-placeholder"></div>
                                <div id="promiscuity-plots-container"></div>
                                <p id="promiscuity-fallback-message" style="text-align:center; display:none; margin-top: 15px;">
                                    Protein parameter not provided.
                                </p>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="ppi-table">
                            <div class="content-section-title">
                                <h2>PPI table</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div class="active-filters">
                                    <h3>Active Filters:</h3>
                                    <div class="filter-tags" id="active-filters"></div>
                                </div>
                                <div class="table-container">
                                    <table id="dataTable">
                                        <thead>
                                            <tr>
                                                <th data-column="partner">
                                                    Partner
                                                </th>
                                                <th data-column="query_fragment">
                                                    Query fragment
                                                </th>
                                                <th data-column="partner_id">
                                                    Uniprot ID
                                                </th>
                                                <th data-column="function">
                                                    Function
                                                </th>
                                                <th data-column="min_pae">
                                                    <span class="header-main-text">min_pae</span>
                                                </th>
                                                <th data-column="avg_pae">
                                                    <span class="header-main-text">avg_pae</span>
                                                </th>
                                                <th data-column="iptm">
                                                    <span class="header-main-text">ipTM</span>
                                                </th>
                                                <th data-column="pdockq">
                                                    <span class="header-main-text">pDockQ</span>
                                                </th>
                                                <th data-column="max_promiscuity">
                                                    <span class="header-main-text">Max Promiscuity</span>
                                                </th>
                                                <th data-column="rop">
                                                    <span class="header-main-text">ROP</span>
                                                </th>
                                                <th data-column="size">
                                                    <span class="header-main-text">Size</span>
                                                </th>
                                                <th data-column="evenness">
                                                    <span class="header-main-text">Evenness</span>
                                                </th>
                                                <th data-column="location">
                                                    Location
                                                </th>
                                                <th data-column="relative_location">
                                                    Relative Location
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataBody"></tbody>
                                    </table>
                                </div>
                                <div class="pagination" id="pagination">
                                </div>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="chord-plot">
                            <div class="content-section-title">
                                <h2>Chord Plot</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div class="control-bar" id="chord-plot-controls" style="margin-bottom: 15px;">
                                    <div class="control-button-group">
                                        <button type="button" id="chord-expand-query-btn" class="control-button" title="Expand query protein arc">
                                            <i class="fas fa-expand-alt"></i> Expand Query
                                        </button>
                                        <button type="button" id="chord-domains-btn" class="control-button active" title="Toggle Domains on Arcs">
                                            <i class="fas fa-layer-group"></i> Domains
                                        </button>
                                    </div>
                                </div>
                                <div class="chord-plot-container">
                                    <!-- Chord plot will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="structure-viewer-section">
                            <div class="content-section-title">
                                <h2>Structure Viewer</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content" style="position: relative;">
                                <div id="structure-controls-placeholder"></div>
                                <div id="structure-viewer"  class="structure-viewer">
                                    <p id="structure-viewer-fallback"
                                        style="text-align:center; padding-top:50px; color:grey;">Loading structure...</p>
                                </div>
                                <div id="structure-sequence-placeholder">
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>
    <div id="footer-placeholder"></div>

    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
    <script type="module" src="js/promiscuity-plot.js"></script>
    <script type="module">
        import { initializeTable } from './js/table.js';
        import { getFilteredData, setOnFiltersChanged, updateActiveFilterDisplay } from './js/filter.js';
        import { fetchProteinData } from './js/data.js';
        import { updatePageTitle } from './js/page-title.js';
        import { initializeChordPlot } from './js/chord-plot.js';
        import { fetchAndParseCSV } from './js/data.js';
        import { initializePromiscuityPlots, updateAllPromiscuityPlots, getPromiscuityFilterState } from './js/promiscuity-plot.js';
        import { loadHTMLIncludes } from './js/header-footer.js';
        import { initCollapsibleSectionsComplex } from './js/collapsible-section.js';
        import { initializeDomainFragmentPlots } from './js/domain-fragment-plot.js';
        import { setUpStructureViewer } from './js/structure-viewer.js';

        const urlParams = new URLSearchParams(window.location.search);
        const p1 = decodeURIComponent(urlParams.get('p1') || '');

        let chordPlotShowDomains = true;
        let chordPlotExpandQuery = false;

        async function initializeChordPlotWrapper() {
            const filteredData = getFilteredData();

            await initializeChordPlot({
                queryProteins: [p1],
                containerSelector: '.chord-plot-container',
                data: filteredData,
                coloringMode: 'byPartner',
                showDomainsOnArcs: chordPlotShowDomains,
                expandQuery: chordPlotExpandQuery
            });
        }

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadHTMLIncludes('navProteins');
            
            // --- Fetch and cache data for the page ---
            const proteinLengthData = await fetchAndParseCSV('all_fragments_2025.06.04.csv');
            const interfaceData = await fetchAndParseCSV('all_interface_analysis_2025.11.26_absolute.csv');

            updatePageTitle([p1]);
            const proteinData = await fetchProteinData(p1);
            console.log("Fetched protein data:", proteinData);
            const accessionId = proteinData ? proteinData.accessionId : null;
            const accessionElement = document.getElementById('uniprot-accession');
            const subheadingElement = document.getElementById('uniprot-accession-subheading');
            accessionElement.textContent = accessionId ? accessionId : 'Not found';
            subheadingElement.innerHTML = accessionId ? `<a href="https://www.uniprot.org/uniprotkb/${accessionId}/entry" target="_blank" rel="noopener noreferrer">${accessionId}</a>` : 'Accession ID Not Found';

            setUpStructureViewer(urlParams, [p1], proteinData);
            initCollapsibleSectionsComplex();

            const chordDomainsBtn = document.getElementById('chord-domains-btn');
            if (chordDomainsBtn) {
                chordDomainsBtn.classList.toggle('active', chordPlotShowDomains);
                chordDomainsBtn.addEventListener('click', async () => {
                    chordPlotShowDomains = !chordPlotShowDomains;
                    chordDomainsBtn.classList.toggle('active', chordPlotShowDomains);
                    await initializeChordPlotWrapper();
                });
            }
            const chordExpandBtn = document.getElementById('chord-expand-query-btn');
            if (chordExpandBtn) {
                chordExpandBtn.classList.toggle('active', chordPlotExpandQuery);
                chordExpandBtn.addEventListener('click', async () => {
                    chordPlotExpandQuery = !chordPlotExpandQuery;
                    chordExpandBtn.classList.toggle('active', chordPlotExpandQuery);
                    await initializeChordPlotWrapper();
                });
            }

            setOnFiltersChanged(async () => {
                updateActiveFilterDisplay();
                if (getPromiscuityFilterState()) {
                    updateAllPromiscuityPlots();
                }
                await initializeChordPlotWrapper();
            });

            await initializeTable({selectedProteins: [p1], searchMode: "includes"});

            await initializeDomainFragmentPlots({
                proteins: [p1]
            });

            await initializeChordPlotWrapper();

            await initializePromiscuityPlots({
                proteins: [p1],
                proteinLengthData,
                interfaceData,
                applyFilters: true
            });

            document.querySelectorAll('.sidebar .sidebar-section ul li a').forEach(link => {
                link.addEventListener('click', function(event) {
                    const targetId = this.getAttribute('href').substring(1);
                    const targetSectionElement = document.getElementById(targetId);

                    if (targetSectionElement) {
                        const contentArea = targetSectionElement.closest('main.content-area');
                        if (contentArea && contentArea.classList.contains('collapsed')) {
                            contentArea.classList.remove('collapsed');
                        }
                    }
                });
            });
        });
    </script>
    </body>
</html>