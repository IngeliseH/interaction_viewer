<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo.png" type="image/png">
    <title>Centrosome Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/button.css">
    <link rel="stylesheet" href="css/collapsible-section.css">
    <link rel="stylesheet" href="css/header-footer.css">
    <link rel="stylesheet" href="css/filter.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/plots.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/stat-cards.css">
    <link rel="stylesheet" href="css/structure-viewer.css">
    <link rel="stylesheet" href="css/table.css">
    <link rel="stylesheet" href="css/tooltip.css">
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="container">
        <div class="main-content">
            <h1 class="page-main-heading">Centrosome Predicted Interaction Data Explorer</h1>
            <div class="grid">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-list-ul"></i> <span>Page Sections</span></h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <ul>
                                <li><a href="#domains-fragments">Domains and Fragments</a></li>
                                <li><a href="#ppi-table">PPI table</a></li>
                                <li><a href="#chord-plot">Chord Plot</a></li>
                                <li><a href="#structure-section">Structure</a></li>
                            </ul>
                        </div>
                    </div>
                </aside>
                    
                <div class="content-column">
                    <main class="content-area">
                        <div class="content-section" id="domains-fragments">
                            <div class="content-section-title">
                                <h2>Domains and Fragments</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div id="domain-fragment-controls-placeholder"></div>
                                <div id="domain-fragment-plot-p1-section">
                                    <h3 id="p1-name-subheading-df" class="page-subtitle">Loading plot...</h3>
                                </div>
                                <div id="domain-fragment-plot-p2-section"></div>
                                <p id="fragments-fallback-message-df" style="text-align:center; display:none; margin-top: 15px;"></p>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="ppi-table">
                            <div class="content-section-title">
                                <h2>PPI table</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div class="active-filters">
                                    <h3>Active Filters:</h3>
                                    <div class="filter-tags" id="active-filters"></div>
                                </div>
                                <div class="table-container">
                                    <table id="dataTable">
                                        <thead>
                                            <tr>
                                                <th data-column="location">Location</th>
                                                <th data-column="min_pae">
                                                    <span class="header-main-text">min_pae</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="avg_pae">
                                                    <span class="header-main-text">avg_pae</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="iptm">
                                                    <span class="header-main-text">ipTM</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="pdockq">
                                                    <span class="header-main-text">pDockQ</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="max_promiscuity">
                                                    <span class="header-main-text">Max Promiscuity</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="rop">
                                                    <span class="header-main-text">ROP</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="size">
                                                    <span class="header-main-text">Size</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="evenness">
                                                    <span class="header-main-text">Evenness</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="relative_location">Relative Location</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                            <!-- Data will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="pagination" id="pagination">
                                    <!-- Pagination will be generated here -->
                                </div>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="chord-plot">
                            <div class="content-section-title">
                                <h2>Chord Plot</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div class="control-bar" id="chord-plot-controls" style="margin-bottom: 15px;">
                                    <div class="control-button-group">
                                        <button type="button" id="chord-domains-btn" class="control-button active" title="Toggle Domains on Arcs">
                                            <i class="fas fa-layer-group"></i> Domains
                                        </button>
                                    </div>
                                </div>
                                <div class="chord-plot-container">
                                    <!-- Chord plot will be rendered here -->
                            </div>
                        </div>
                    </main>
                    <!-- Structure Section Start -->
                    <main class="content-area">
                        <div class="content-section" id="structure-section">
                            <div class="content-section-title">
                                <h2>Structure</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content" style="position: relative;">
                                <!-- Div for the structure grid -->
                                <div id="structure-grid-container">
                                    <!-- Grid will be populated here by JavaScript -->
                                </div>
                                <!-- Structure viewer controls -->
                                <div id="structure-controls" class="structure-controls">
                                    <div class="control-bar">
                                        <div class="control-button-group">
                                            <button type="button" class="control-button reset" title="Reset View">
                                                <i class="fas fa-undo"></i> Reset
                                            </button>
                                            <button type="button" class="control-button atoms-btn" title="Atoms">
                                                <i class="fas fa-grip-lines"></i> Atoms
                                            </button>
                                            <button type="button" class="control-button surface-btn" title="Surface">
                                                <i class="fas fa-layer-group"></i> Surface
                                            </button>
                                            <button type="button" class="control-button color-mode" title="Toggle Color Mode">
                                                <i class="fas fa-palette"></i> Spectrum
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="structure-viewer-pair-page" class="structure-viewer"
                                     data-pdb=""> <!-- PDB path will be set dynamically -->
                                    <p id="structure-viewer-fallback" style="text-align:center; padding-top:50px; color:grey;">Select fragments from the grid to view structure.</p>
                                </div>
                            </div>
                        </div>
                    </main>
                    <!-- Structure Section End -->
                </div>
            </div>
        </div>
    </div>
    <div id="footer-placeholder"></div>

    <script src="js/structure-viewer.js"></script>
    <script src="js/interaction-structure-viewer.js"></script>
    <script type="module">
        import * as table from './js/table.js';
        import * as filter from './js/filter.js';
        import * as pagination from './js/pagination.js';
        import * as stats from './js/stats.js';
        import { initializeChordPlot } from './js/chord-plot.js';
        import { loadHTMLIncludes } from './js/header-footer.js';
        import { initCollapsibleSectionsComplex } from './js/collapsible-section.js';
        import { initializeDomainFragmentPlots } from './js/domain-fragment-plot.js';

        window.activeFilters = {};

        let chordPlotShowDomains = true;
        const urlParams = new URLSearchParams(window.location.search);
        const p1 = decodeURIComponent(urlParams.get('p1') || '');
        const p2 = decodeURIComponent(urlParams.get('p2') || '');

        function updatePageTitleWithProteinPair(urlParams, p1, p2) {
            const f1_id = decodeURIComponent(urlParams.get('f1_id') || '');
            const f2_id = decodeURIComponent(urlParams.get('f2_id') || '');

            const pageTitleElement = document.querySelector('.page-main-heading');
            const p1DFSubheading = document.getElementById('p1-name-subheading-df');
            const p2DFSubheading = document.getElementById('p2-name-subheading-df');

            if (p1 && p2) {
                const p1Display = f1_id ? `${p1} (Fragments: ${f1_id.replace(/,/g, ', ')})` : p1;
                const p2Display = f2_id ? `${p2} (Fragments: ${f2_id.replace(/,/g, ', ')})` : p2;
                const title = `${p1Display} + ${p2Display}`;
                
                document.title = title;
                if (pageTitleElement) pageTitleElement.textContent = title;
                if (p1DFSubheading) p1DFSubheading.textContent = `${p1}`;
                if (p2DFSubheading) p2DFSubheading.textContent = `${p2}`;

            } else {
                console.warn("Proteins parameter format is incorrect or p1/p2 not provided.");
                document.title = "Centrosome Predicted Interaction Data Explorer";
                if (pageTitleElement) {
                    pageTitleElement.textContent = "Centrosome Predicted Interaction Data Explorer";
                }
                if (protein1DFSubheading) protein1DFSubheading.textContent = 'Protein 1 not specified';
                if (protein2DFSubheading) protein2DFSubheading.style.display = 'none';
                
                const fallbackMessageDF = document.getElementById('fragments-fallback-message-df');
                if(fallbackMessageDF) {
                    fallbackMessageDF.textContent = 'Protein parameters not provided to display domain/fragment plots.';
                    fallbackMessageDF.style.display = 'block';
                }
            }
        }

        async function initializeChordPlotWrapper() {
            const filteredData = filter.getFilteredData();

            await initializeChordPlot({
                queryProteins: [p1, p2],
                containerSelector: '.chord-plot-container',
                data: filteredData,
                arcColoringMode: 'greyOnly',
                coloringMode: 'varied',
                showDomainsOnArcs: chordPlotShowDomains
            });
        }

        // --- Table column descriptions for info tooltips ---
        table.setColumnDescriptions({
            "location": "Location of the regions involved in this predicted interaction in each full length protein. This is not necessarily every interacting region between these proteins or these fragments.",
            "min_pae": "Minimum PAE value for the interface. PAE gives the predicted error in the relative positioning of 2 residues, with lower values indicating more confident relative positioning. This is the best (lowest) PAE for any pair of residues from different proteins in this interface.",
            "avg_pae": "Average PAE across the interface. PAE gives the predicted error in the relative positioning of 2 residues, with lower values indicating more confident relative positioning. This is the average PAE for all pairs of residues from different proteins in this interface.",
            "iptm": "Interface predicted TM-score (ipTM). Higher values indicate higher model quality (0-1). Values above 0.55 indicate an interaction. Scores are typically lower on coiled coil predictions and predictions with larger input, especially when multiple regions of the predicted structure are within interaction distance with varying confidences. ",
            "pdockq": "pDockQ score estimates the goodness of fit of the modeled interaction interface (0-1). It is based on the actual structure rather than prediction confidence. Scores above 0.23 indicate a plausible interaction. Can be biased towards coiled-coil structures.",
            "max_promiscuity": "The higher of the two partners' promiscuity scores. Represents the number of other interactions predicted for the same interface region. A high score may indicate a non-specific binding site, or completion bias.",
            "rop": "Repeatability of Prediction. How many times (out of 4) the same interface was predicted in repeat runs. A score of 4 indicates high consistency.",
            "size": "The number of residue pairs within interaction distance at the interface.",
            "evenness": "How evenly balanced the interaction confidence is in each direction (Protein 1 -> Protein 2 vs. Protein 2 -> Protein 1).",
            "relative_location": "The interacting residue ranges within the protein fragments used for prediction. Useful for mapping to the predicted structure."
        });

        // --- Table initialization and filtering ---
        async function initializePPITableForProtein() {
            await table.loadTableData();
            filter.setSelectedProteins([p1, p2]);
            table.setSearchMode("pair-exact");
            pagination.setCurrentPage(1);
            pagination.setUpdatePaginationUI(pagination.updatePaginationControls);
            stats.setUpdateStatsUI(null);
            table.initTable();
            filter.updateActiveFilterDisplay();
            table.renderTable();
            await initializeChordPlotWrapper();
        }

        async function setupStructureSection() {
            const f1_id_param = decodeURIComponent(urlParams.get('f1_id') || '');
            const f2_id_param = decodeURIComponent(urlParams.get('f2_id') || '');

            let f1Fragments = [];
            let f2Fragments = [];

            if (f1_id_param) f1Fragments = f1_id_param.split(',').map(f => f.trim()).filter(f => f);
            if (f2_id_param) f2Fragments = f2_id_param.split(',').map(f => f.trim()).filter(f => f);

            const gridContainer = document.getElementById('structure-grid-container');
            const viewerDiv = document.getElementById('structure-viewer-pair-page');
            const fallback = document.getElementById('structure-viewer-fallback');
            const controlsContainer = document.getElementById('structure-controls');
            controlsContainer.style.display = 'none';

            if (!gridContainer || !viewerDiv || !fallback || !controlsContainer) {
                console.error("Structure section elements not found. Needed: gridContainer, viewerDiv, fallback, controlsContainer.", {gridContainer, viewerDiv, fallback, controlsContainer});
                if (fallback) fallback.textContent = "Structure viewer components missing from page. Please check console.";
                return;
            }
            
            if (typeof $3Dmol === 'undefined') {
                console.error("setupStructureSection: 3Dmol.js library not loaded or $3Dmol is not defined.");
                viewerDiv.innerHTML = "<p style='color:red; text-align:center;'>Error: 3Dmol.js library failed to load. Structure viewer cannot be initialized.</p>";
                controlsContainer.style.display = 'none';
                return;
            }

            if (f1Fragments.length === 0 || f2Fragments.length === 0) {
                if (fallback) fallback.textContent = "Fragment information missing, cannot display structure grid or viewer.";
                gridContainer.innerHTML = "<p style='text-align:center;'>Fragment information not available to build the grid.</p>";
                controlsContainer.style.display = 'none';
                return;
            } else {
                 if (fallback) fallback.textContent = "Select fragments from the grid to view structure";
            }

            let pdbFiles = [];
            try {
                const response = await fetch('structures/pdb_files.txt');
                if (response.ok) {
                    const fileListText = await response.text();
                    pdbFiles = fileListText.split('\n').filter(f => f.endsWith('.pdb'));
                } else {
                    console.error('Could not fetch structures/pdb_files.txt. Structure links may be broken.');
                    gridContainer.innerHTML = `<p style="color:red; text-align:center;">Could not load PDB file list. Cannot build structure grid.</p>`;
                    return;
                }
            } catch (error) {
                console.error('Error fetching PDB file list:', error);
                gridContainer.innerHTML = `<p style="color:red; text-align:center;">Error loading PDB file list. Cannot build structure grid.</p>`;
                return;
            }

            let proteinForX, fragmentsForX, proteinForY, fragmentsForY;

            if (f1Fragments.length < f2Fragments.length) {
                proteinForY = p1;
                fragmentsForY = f1Fragments;
                proteinForX = p2;
                fragmentsForX = f2Fragments;
            } else {
                proteinForY = p2;
                fragmentsForY = f2Fragments;
                proteinForX = p1;
                fragmentsForX = f1Fragments;
            }

            let gridLayoutHtml = `<div>
                <div class="structure-grid-protein-x-label">${proteinForX}</div>
                <div class="structure-grid-y-label-table-container">
                <div class="structure-grid-protein-y-label">${proteinForY}</div>
                <div>`;
            let tableHtml = `<table class="structure-grid">
                <tr><th></th>`
            fragmentsForX.forEach(fX => {
                tableHtml += `<th class="structure-grid-col-header">${fX}</th>`;
            });
            tableHtml += '</tr>';
            fragmentsForY.forEach(fY => {
                tableHtml += `<tr><th class="structure-grid-row-header">${fY}</th>`;
                fragmentsForX.forEach(fX => {
                    const p1_frag = `${proteinForX}_F${fX}`;
                    const p2_frag = `${proteinForY}_F${fY}`;
                    const prefix1 = `${p1_frag}_${p2_frag}`;
                    const prefix2 = `${p2_frag}_${p1_frag}`;
                    
                    const pdbFile = pdbFiles.find(f => f.startsWith(prefix1) || f.startsWith(prefix2));
                    const filePath = pdbFile ? `structures/${pdbFile}` : "";
                    const buttonDisabled = !filePath ? 'disabled' : '';
                    const buttonTitle = filePath 
                        ? `View structure for ${proteinForX} F${fX} + ${proteinForY} F${fY}`
                        : `Structure not available for ${proteinForX} F${fX} + ${proteinForY} F${fY}`;
                    const buttonIcon = filePath ? '&#128269;' : '&#10060;'; // Magnifying glass or cross mark

                    tableHtml += `<td class="structure-grid-cell">
                        <button class="structure-cell-btn" 
                            data-p1="${proteinForX}" data-f1="${fX}" 
                            data-p2="${proteinForY}" data-f2="${fY}" 
                            data-file="${filePath}" 
                            title="${buttonTitle}" ${buttonDisabled}>${buttonIcon}</button>
                    </td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += `</table>
                </div>
                </div>
                </div>`;
            gridLayoutHtml += tableHtml;
            gridContainer.innerHTML = gridLayoutHtml;


            // Click handlers for grid cells
            gridContainer.querySelectorAll('.structure-cell-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const currentlySelected = gridContainer.querySelector('.structure-grid-cell.selected');
                    if (currentlySelected) currentlySelected.classList.remove('selected');
                    this.closest('.structure-grid-cell').classList.add('selected');

                    const file = this.getAttribute('data-file');
                    const viewerDiv = document.getElementById('structure-viewer-pair-page');
                    const controlsContainer = document.getElementById('structure-controls');

                    if (file) {
                        viewerDiv.innerHTML = '';
                        if (controlsContainer) controlsContainer.style.display = '';
                        const viewerOptions = window.getInteractionViewerOptions ? window.getInteractionViewerOptions() : {};
                        window.displayStructureInViewer(viewerDiv, file, viewerOptions);
                    }
                });
            });
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            await loadHTMLIncludes('navProteinPairs');
            updatePageTitleWithProteinPair(urlParams, p1, p2);
            initCollapsibleSectionsComplex();

            // Chord plot controls
            const chordDomainsBtn = document.getElementById('chord-domains-btn');
            if (chordDomainsBtn) {
                chordDomainsBtn.classList.toggle('active', chordPlotShowDomains);
                chordDomainsBtn.addEventListener('click', async () => {
                    chordPlotShowDomains = !chordPlotShowDomains;
                    chordDomainsBtn.classList.toggle('active', chordPlotShowDomains);
                    await initializeChordPlotWrapper();
                });
            }

            // Define initial filters for this page (directly for columnFilters)
            const initialNumericFiltersForProteinPage = {
                min_pae: { max: 5 }, // min_pae <= 5
                avg_pae: { max: 15 }, // avg_pae <= 15
                rop: { min: 2 }      // rop >= 2 (as per original user request for protein page)
            };

            filter.setOnFiltersChanged(async () => {
                filter.updateActiveFilterDisplay();
                await initializeChordPlotWrapper();
            });

            if (p1 && p2) {
                filter.setColumnFilters(initialNumericFiltersForProteinPage, false);
                await initializePPITableForProtein();
                await initializeDomainFragmentPlots({
                    proteins: p1 === p2 ? [p1] : [p1, p2],
                    fallbackMessageSelector: '#fragments-fallback-message-df'
                });
                await initializeChordPlotWrapper();
            } else {
                console.warn("Protein names not provided in URL parameters. Cannot initialize table.");
                const tableBody = document.getElementById('dataBody');
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Protein names not specified in URL parameters.</td></tr>`;
                }
            }

            await setupStructureSection(urlParams, p1, p2);
        });
    </script>
</body>
</html>