<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo.png" type="image/png">
    <title>Centrosome Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/button.css">
    <link rel="stylesheet" href="css/collapsible-section.css">
    <link rel="stylesheet" href="css/header-footer.css">
    <link rel="stylesheet" href="css/filter.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/plots.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/stat-cards.css">
    <link rel="stylesheet" href="css/structure-viewer.css">
    <link rel="stylesheet" href="css/table.css">
    <link rel="stylesheet" href="css/tooltip.css">
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="container">
        <div class="main-content">
            <h1 class="page-main-heading">Centrosome Predicted Interaction Data Explorer</h1>
            <div class="grid">
                <aside class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <h2><i class="fas fa-list-ul"></i> <span>Page Sections</span></h2>
                            <i class="fas fa-chevron-up"></i>
                        </div>
                        <div class="sidebar-content">
                            <ul>
                                <li><a href="#domains-fragments">Domains and Fragments</a></li>
                                <li><a href="#ppi-table">PPI table</a></li>
                                <li><a href="#chord-plot">Chord Plot</a></li>
                                <li><a href="#structure-viewer">Structure</a></li>
                            </ul>
                        </div>
                    </div>
                </aside>
                    
                <div class="content-column">
                    <main class="content-area">
                        <div class="content-section" id="domains-fragments">
                            <div class="content-section-title">
                                <h2>Domains and Fragments</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div id="domain-fragment-controls-placeholder"></div>
                                <div id="domain-fragment-plots-container"></div>
                                <p id="domain-fragments-fallback-message" style="text-align:center; display:none; margin-top: 15px;">
                                    Loading domain and fragment plots...
                                </p>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="ppi-table">
                            <div class="content-section-title">
                                <h2>PPI table</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div class="active-filters">
                                    <h3>Active Filters:</h3>
                                    <div class="filter-tags" id="active-filters"></div>
                                </div>
                                <div class="table-container">
                                    <table id="dataTable">
                                        <thead>
                                            <tr>
                                                <th data-column="location">Location</th>
                                                <th data-column="min_pae">
                                                    <span class="header-main-text">min_pae</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="avg_pae">
                                                    <span class="header-main-text">avg_pae</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="iptm">
                                                    <span class="header-main-text">ipTM</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="pdockq">
                                                    <span class="header-main-text">pDockQ</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="max_promiscuity">
                                                    <span class="header-main-text">Max Promiscuity</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="rop">
                                                    <span class="header-main-text">ROP</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="size">
                                                    <span class="header-main-text">Size</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="evenness">
                                                    <span class="header-main-text">Evenness</span> 
                                                    <span class="filter-icon">
                                                        <i class="fas fa-filter"></i>
                                                    </span>
                                                </th>
                                                <th data-column="relative_location">Relative Location</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                            <!-- Data will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="pagination" id="pagination">
                                    <!-- Pagination will be generated here -->
                                </div>
                            </div>
                        </div>
                    </main>
                    <main class="content-area">
                        <div class="content-section" id="chord-plot">
                            <div class="content-section-title">
                                <h2>Chord Plot</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content">
                                <div class="control-bar" id="chord-plot-controls" style="margin-bottom: 15px;">
                                    <div class="control-button-group">
                                        <button type="button" id="chord-domains-btn" class="control-button active" title="Toggle Domains on Arcs">
                                            <i class="fas fa-layer-group"></i> Domains
                                        </button>
                                    </div>
                                </div>
                                <div class="chord-plot-container">
                                    <!-- Chord plot will be rendered here -->
                            </div>
                        </div>
                    </main>
                    <!-- Structure Section Start -->
                    <main class="content-area">
                        <div class="content-section" id="structure-viewer-section">
                            <div class="content-section-title">
                                <h2>Structure</h2>
                                <i class="fas fa-chevron-up"></i>
                            </div>
                            <div class="content-section-content" style="position: relative;">
                                <div id="structure-grid-container"></div>
                                <div id="structure-controls-placeholder"></div>
                                <div id="structure-viewer" class="structure-viewer">
                                   <p id="structure-viewer-fallback" style="text-align:center; padding-top:50px; color:grey;">Select fragments from the grid to view structure.</p>
                                </div>
                            </div>
                        </div>
                    </main>
                    <!-- Structure Section End -->
                </div>
            </div>
        </div>
    </div>
    <div id="footer-placeholder"></div>

    <script type="module">
        import * as table from './js/table.js';
        import * as filter from './js/filter.js';
        import * as pagination from './js/pagination.js';
        import { updatePageTitle } from './js/page-title.js';
        import { setUpdateStatsUI } from './js/stats.js';
        import { initializeChordPlot } from './js/chord-plot.js';
        import { loadHTMLIncludes } from './js/header-footer.js';
        import { initCollapsibleSectionsComplex } from './js/collapsible-section.js';
        import { initializeDomainFragmentPlots } from './js/domain-fragment-plot.js';
        import { setUpStructureViewer } from './js/structure-viewer.js';

        window.activeFilters = {};

        let chordPlotShowDomains = true;
        const urlParams = new URLSearchParams(window.location.search);
        const p1 = decodeURIComponent(urlParams.get('p1') || '');
        const p2 = decodeURIComponent(urlParams.get('p2') || '');

        async function initializeChordPlotWrapper() {
            const filteredData = filter.getFilteredData();

            await initializeChordPlot({
                queryProteins: [p1, p2],
                containerSelector: '.chord-plot-container',
                data: filteredData,
                arcColoringMode: 'greyOnly',
                coloringMode: 'varied',
                showDomainsOnArcs: chordPlotShowDomains
            });
        }

        // --- Table column descriptions for info tooltips ---
        table.setColumnDescriptions({
            "location": "Location of the regions involved in this predicted interaction in each full length protein. This is not necessarily every interacting region between these proteins or these fragments.",
            "min_pae": "Minimum PAE value for the interface. PAE gives the predicted error in the relative positioning of 2 residues, with lower values indicating more confident relative positioning. This is the best (lowest) PAE for any pair of residues from different proteins in this interface.",
            "avg_pae": "Average PAE across the interface. PAE gives the predicted error in the relative positioning of 2 residues, with lower values indicating more confident relative positioning. This is the average PAE for all pairs of residues from different proteins in this interface.",
            "iptm": "Interface predicted TM-score (ipTM). Higher values indicate higher model quality (0-1). Values above 0.55 indicate an interaction. Scores are typically lower on coiled coil predictions and predictions with larger input, especially when multiple regions of the predicted structure are within interaction distance with varying confidences. ",
            "pdockq": "pDockQ score estimates the goodness of fit of the modeled interaction interface (0-1). It is based on the actual structure rather than prediction confidence. Scores above 0.23 indicate a plausible interaction. Can be biased towards coiled-coil structures.",
            "max_promiscuity": "The higher of the two partners' promiscuity scores. Represents the number of other interactions predicted for the same interface region. A high score may indicate a non-specific binding site, or completion bias.",
            "rop": "Repeatability of Prediction. How many times (out of 4) the same interface was predicted in repeat runs. A score of 4 indicates high consistency.",
            "size": "The number of residue pairs within interaction distance at the interface.",
            "evenness": "How evenly balanced the interaction confidence is in each direction (Protein 1 -> Protein 2 vs. Protein 2 -> Protein 1).",
            "relative_location": "The interacting residue ranges within the protein fragments used for prediction. Useful for mapping to the predicted structure."
        });

        // --- Table initialization and filtering ---
        async function initializePPITableForProtein() {
            await table.loadTableData();
            filter.setSelectedProteins([p1, p2]);
            table.setSearchMode("pair-exact");
            pagination.setCurrentPage(1);
            pagination.setUpdatePaginationUI(pagination.updatePaginationControls);
            setUpdateStatsUI(null);
            table.initTable();
            filter.updateActiveFilterDisplay();
            table.renderTable();
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            await loadHTMLIncludes('navProteinPairs');
            updatePageTitle([p1, p2]);
            initCollapsibleSectionsComplex();

            // Chord plot controls
            const chordDomainsBtn = document.getElementById('chord-domains-btn');
            if (chordDomainsBtn) {
                chordDomainsBtn.classList.toggle('active', chordPlotShowDomains);
                chordDomainsBtn.addEventListener('click', async () => {
                    chordPlotShowDomains = !chordPlotShowDomains;
                    chordDomainsBtn.classList.toggle('active', chordPlotShowDomains);
                    await initializeChordPlotWrapper();
                });
            }

            // Define initial filters
            const initialNumericFilters = {
                min_pae: { max: 5 },
                avg_pae: { max: 15 },
                rop: { min: 2 }
            };

            filter.setOnFiltersChanged(async () => {
                filter.updateActiveFilterDisplay();
                await initializeChordPlotWrapper();
            });

            if (!p1 || !p2) {
                console.warn("Protein names not provided in URL parameters.");
            }
            filter.setColumnFilters(initialNumericFilters, false);
            await initializePPITableForProtein();
            await initializeDomainFragmentPlots({
                proteins: p1 === p2 ? [p1] : [p1, p2]
            });
            await initializeChordPlotWrapper();
            await setUpStructureViewer(urlParams, [p1, p2], null);
        });
    </script>
</body>
</html>